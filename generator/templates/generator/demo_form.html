<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LL-HTML Demo</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand" href="#"><i class="fas fa-shield-alt"></i> LL-HTML Demo</a>
            {% if user.is_authenticated %}
            <div class="navbar-nav ms-auto">
                <div class="nav-item dropdown">
                    <a class="nav-link dropdown-toggle text-white" href="#" id="navbarDropdown" role="button" data-bs-toggle="dropdown">
                        <i class="fas fa-user"></i> {{ user.email }}
                    </a>
                    <ul class="dropdown-menu">
                        <li><a class="dropdown-item" href="/accounts/logout/"><i class="fas fa-sign-out-alt"></i> Logout</a></li>
                    </ul>
                </div>
            </div>
            {% endif %}
        </div>
    </nav>
    
    <div class="container mt-4">
        <div class="row justify-content-center">
            <div class="col-md-8">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="fas fa-magic"></i> Generate Disaster Response Page</h5>
                    </div>
                    <div class="card-body">
                        <form id="generateForm">
                            <div class="mb-3">
                                <label for="userRequest" class="form-label">What kind of disaster response page do you need?</label>
                                <textarea 
                                    class="form-control" 
                                    id="userRequest" 
                                    rows="4" 
                                    placeholder="Example: Create a hurricane tracking dashboard for Miami residents with evacuation routes and shelter locations"
                                    required
                                ></textarea>
                                <div class="form-text">Describe what information you need and who will use it.</div>
                            </div>
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-cog fa-spin d-none" id="loadingIcon"></i>
                                <i class="fas fa-magic" id="generateIcon"></i>
                                <span id="buttonText">Generate Page</span>
                            </button>
                        </form>
                        
                        <div id="result" class="mt-4" style="display: none;">
                            <div class="alert alert-success">
                                <h6><i class="fas fa-check-circle"></i> Page Generated Successfully!</h6>
                                <p class="mb-2">Generation time: <span id="generationTime"></span> seconds</p>
                                <a href="#" id="viewPageLink" class="btn btn-sm btn-outline-primary" target="_blank">
                                    <i class="fas fa-external-link-alt"></i> View Generated Page
                                </a>
                            </div>
                        </div>
                        
                        <div id="error" class="mt-4" style="display: none;">
                            <div class="alert alert-danger">
                                <h6><i class="fas fa-exclamation-triangle"></i> Generation Failed</h6>
                                <p id="errorMessage"></p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="card mt-4">
                    <div class="card-header">
                        <h6 class="mb-0"><i class="fas fa-history"></i> Recent Pages</h6>
                    </div>
                    <div class="card-body">
                        <div id="recentPages">
                            <p class="text-muted">Loading...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const form = document.getElementById('generateForm');
        const loadingIcon = document.getElementById('loadingIcon');
        const generateIcon = document.getElementById('generateIcon');
        const buttonText = document.getElementById('buttonText');
        const result = document.getElementById('result');
        const error = document.getElementById('error');
        
        // Load recent pages
        loadRecentPages();
        
        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const userRequest = document.getElementById('userRequest').value;
            
            // Show loading state
            loadingIcon.classList.remove('d-none');
            generateIcon.classList.add('d-none');
            buttonText.textContent = 'Generating...';
            form.querySelector('button').disabled = true;
            result.style.display = 'none';
            error.style.display = 'none';
            
            try {
                const response = await fetch('/generator/api/generate/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCookie('csrftoken')
                    },
                    body: JSON.stringify({ user_request: userRequest })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    document.getElementById('generationTime').textContent = data.generation_time.toFixed(2);
                    document.getElementById('viewPageLink').href = `/generator/view/${data.page.id}/`;
                    result.style.display = 'block';
                    loadRecentPages(); // Refresh recent pages
                } else {
                    document.getElementById('errorMessage').textContent = data.error || 'Unknown error occurred';
                    error.style.display = 'block';
                }
            } catch (err) {
                document.getElementById('errorMessage').textContent = 'Network error: ' + err.message;
                error.style.display = 'block';
            }
            
            // Reset button state
            loadingIcon.classList.add('d-none');
            generateIcon.classList.remove('d-none');
            buttonText.textContent = 'Generate Page';
            form.querySelector('button').disabled = false;
        });
        
        async function loadRecentPages() {
            try {
                const response = await fetch('/generator/api/pages/');
                const pages = await response.json();
                
                const container = document.getElementById('recentPages');
                if (pages.length === 0) {
                    container.innerHTML = '<p class="text-muted">No pages generated yet.</p>';
                } else {
                    container.innerHTML = pages.map(page => `
                        <div class="d-flex justify-content-between align-items-center border-bottom py-2">
                            <div>
                                <strong>${page.title}</strong>
                                <br>
                                <small class="text-muted">${new Date(page.created_at).toLocaleString()}</small>
                            </div>
                            <a href="/generator/view/${page.id}/" class="btn btn-sm btn-outline-primary" target="_blank">View</a>
                        </div>
                    `).join('');
                }
            } catch (err) {
                document.getElementById('recentPages').innerHTML = '<p class="text-muted">Error loading recent pages.</p>';
            }
        }
        
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
    </script>
</body>
</html>